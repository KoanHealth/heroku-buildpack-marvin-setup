#!/usr/bin/env ruby

# sync output
$stdout.sync = true

$:.unshift File.expand_path("../../lib", __FILE__)
require "language_pack"
require "language_pack/shell_helpers"
DEPLOY_PATH='./deploy'

build_path = ARGV[0]

LanguagePack::Instrument.trace 'compile', 'app.compile' do
  puts 'installing Bundler'
  LanguagePack::Helpers::BundlerWrapper.new.install

  Dir.chdir(build_path) do
    puts "Working in: #{Dir.pwd}"

    puts 'cloning deploy repo'
    `git clone git@github.com:KoanHealth/Deploy.git #{DEPLOY_PATH}`
    puts 'Compile dir files:'

    ENV['PATH'] = "#{ENV['PATH']}:#{LanguagePack::Helpers::BundlerWrapper::BUNDLER_PATH}"
    puts 'Bundler path'
    Dir.foreach(LanguagePack::Helpers::BundlerWrapper::BUNDLER_PATH) {|file| puts file}
    Dir.chdir(DEPLOY_PATH) do
      puts 'Running deploy setup'
      `script/setup.sh`
    end
  end
end
