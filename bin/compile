#!/usr/bin/env ruby

# sync output
$stdout.sync = true

$:.unshift File.expand_path("../../lib", __FILE__)
require "language_pack"
require "language_pack/shell_helpers"
DEPLOY_PATH='./deploy'

build_path = ARGV[0]

LanguagePack::Instrument.trace 'compile', 'app.compile' do
  puts 'installing Bundler'
  bundle_master = LanguagePack::Helpers::BundlerWrapper.new
  bundle_master.install

  Dir.chdir(build_path) do
    puts "Working in: #{Dir.pwd}"

    puts 'cloning deploy repo'
    `git clone git@github.com:KoanHealth/Deploy.git #{DEPLOY_PATH}`
    puts 'Compile dir files:'

    bundle_exec_path = "#{bundle_master.bundler_path}/bin"

    ENV['PATH'] = "#{ENV['PATH']}:#{bundle_exec_path}"
    puts 'Bundler path'
    Dir.foreach(bundle_exec_path) {|file| puts file}
    Dir.chdir(DEPLOY_PATH) do
      puts 'Running deploy setup'
      `script/setup.sh`
    end
  end
end
